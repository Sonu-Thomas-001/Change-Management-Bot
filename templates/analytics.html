<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #f4f6f8; padding: 40px; margin: 0; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 30px; }
        h2 { margin-top: 0; font-size: 1.2rem; color: #555; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px;}
        h3 { margin-top: 40px; margin-bottom: 15px; }

        /* Grid Layout */
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-bottom: 30px; }
        
        /* Cards */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Top Row: Stats */
        .stat-card { grid-column: span 4; text-align: center; }
        .number { font-size: 2.5rem; font-weight: bold; color: #007bff; margin: 10px 0; }
        .alert { color: #dc3545; }
        
        /* Middle Row: Charts & Lists */
        .chart-card { grid-column: span 8; height: 400px; }
        .list-card { grid-column: span 4; height: 400px; overflow-y: auto; }

        /* Feedback Scores */
        .fb-up { color: #155724; background: #d4edda; padding: 4px 12px; border-radius: 15px; margin-right: 10px; }
        .fb-down { color: #721c24; background: #f8d7da; padding: 4px 12px; border-radius: 15px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px;}
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        th { background: #007bff; color: white; font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }
        
        /* Status Pills */
        .status { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        .status-Answered { background: #d4edda; color: #155724; }
        .status-Unanswered { background: #f8d7da; color: #721c24; }
        
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; font-weight: 600; }

        /* Simple List Styles */
        .simple-list { list-style: none; padding: 0; margin: 0; }
        .simple-list li { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .count-badge { background: #e9ecef; padding: 2px 8px; border-radius: 10px; font-size: 0.85rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Chatbot</a>
        <h1>üìä Analytics Dashboard</h1>
        
        <div class="dashboard-grid">
            <div class="card stat-card">
                <h2>Total Queries</h2>
                <div class="number">{{ total }}</div>
            </div>
            <div class="card stat-card">
                <h2>Unanswered (Gap)</h2>
                <div class="number alert">{{ unanswered_count }}</div>
            </div>
            <div class="card stat-card">
                <h2>User Satisfaction</h2>
                <div class="number">
                    <span class="fb-up">üëç {{ positive_fb }}</span>
                    <span class="fb-down">üëé {{ negative_fb }}</span>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card chart-card">
                <h2>üìà Daily Query Trend</h2>
                <canvas id="trendChart"></canvas>
            </div>
            
            <div class="card list-card">
                <h2>üî• Most Asked Questions</h2>
                <ul class="simple-list">
                    {% if most_common_questions %}
                        {% for q, count in most_common_questions %}
                        <li>
                            <span style="width:80%;">{{ q }}</span>
                            <span class="count-badge">{{ count }}</span>
                        </li>
                        {% endfor %}
                    {% else %}
                        <p>No data yet.</p>
                    {% endif %}
                </ul>
            </div>
        </div>

        <h3 style="color: #dc3545;">‚ö†Ô∏è Gap Analysis: Unanswered Questions</h3>
        <p style="margin-bottom: 15px; color: #666;">These questions returned no results. Review to improve your SOP.</p>
        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">Time</th>
                    <th>Question Asked</th>
                </tr>
            </thead>
            <tbody>
                {% if unanswered_list %}
                    {% for row in unanswered_list %}
                    <tr>
                        <td>{{ row.Timestamp }}</td>
                        <td>{{ row.Question }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="2" style="text-align:center;">Great job! No unanswered questions logged.</td></tr>
                {% endif %}
            </tbody>
        </table>

        <h3>üìù Recent Query Log (Last 50)</h3>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Question</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% if logs %}
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.Timestamp }}</td>
                        <td>{{ log.Question }}</td>
                        <td><span class="status status-{{ log.Status }}">{{ log.Status }}</span></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="3" style="text-align:center;">No queries yet.</td></tr>
                {% endif %}
            </tbody>
        </table>

    </div>

    <script>
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // Data passed from Flask
        const chartLabels = {{ chart_labels | tojson }};
        const chartData = {{ chart_data | tojson }};

        const trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Queries per Day',
                    data: chartData,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    </script>
</body>
</html>